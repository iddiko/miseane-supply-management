# 제품 공급·판매 전산 시스템 요구사항 명세서

> 작성자: ChatGPT (요구사항 초안)
> 대상: 요양원 / 요양병원 / 경로당 등 B2B 공급 시뮬레이션 기반 전산 시스템
> 목적: 사용자가 첨부한 스프레드시트(제품별 원가·공급가·판매가·수익분배)를 전산화하여
> - 제품 추가/수정/삭제
> - 실시간 가격/수익 시뮬레이션
> - 권한별(본사/지사/지점/협력사/병원) 뷰 및 접근 제어
> - 보고서/정산 자동화
> 를 할 수 있게 만드는 것을 목표로 한다.

---

## 1. 개요 및 목표

### 1.1 배경
- 현재 제품별 원가·공급가·판매가·보증금·수익 배분 등 계산이 엑셀로 이루어짐.
- 수작업으로 제품을 추가/변경/삭제할 때마다 엑셀 수식 수정 및 배포가 필요.

### 1.2 목표
- 실무자가 제품을 쉽게 관리하고, 권한에 따라 필요한 항목만 보게 하며, 자동으로 매출·수익·배분을 계산하는 전산 시스템 구축.
- 본사/지사/지점/협력사/병원 등 역할별로 메뉴와 리포트를 달리 보여주는 RBAC (Role-Based Access Control) 적용.
- 제품 데이터의 버전 관리 및 감사 로그 제공.

---

## 2. 이해관계자(역할) 및 권한 요약

| 역할 | 설명 | 주요 권한/메뉴 접근 |
|---|---:|---|
| SuperAdmin(시스템관리자) | 시스템 최상위 권한 | 모든 메뉴 접근 및 설정, 사용자/권한 관리
| HQ(본사 관리자) | 제품/정책/정산의 최종 결정권자 | 제품관리, 가격정책, 계약, 본사 리포트, 사용자관리(지사/지점)
| RegionalAdmin(지사 관리자) | 지역 단위 운영 | 지사 관할의 지점들 보기/관리, 리포트 조회, 재고확인
| BranchAdmin(지점 관리자) | 현장 운영 | 지점 제품 재고/발주, 일별/월별 매출 리포트
| Partner(협력사) | 납품/유통 파트너 | 협력사 전용 리포트, 계약/정산 확인
| HospitalUser(병원/요양원 담당자) | 고객사 담당자 | 납품 내역, 소비자 가격, 청구서 보기(읽기전용)
| DataEntry | 데이터 입력 담당 | 제품 등록/수정(권한 제한), 발주 입력
| Auditor | 회계/감사 담당 | 감사 로그, 트랜잭션 리포트(읽기전용)

> 각 역할은 커스터마이징 가능한 권한 집합을 사용한다. (예: 제품 수정 가능 여부, 가격 수정 가능 여부 등)

---

## 3. 핵심 기능(MVP)

1. 제품 관리(CRUD)
   - 제품 추가/수정/삭제(소프트 삭제)
   - 제품 상세: SKU, 품명, 용량, 단위, 원가(수량·단가), 공급가, 소비자 판매가, 보증금, 1회성 여부, 이미지/첨부파일
   - 가격 변동 이력(Price History) 자동 기록

2. 가격·수익 계산 엔진
   - 수익(단위/총액), 매출(단위/총액), 배분(본사/지사/지점/협력사 등 비율 기반) 자동 계산
   - 계산식은 관리자 화면에서 규칙(비율, 세금, 수수료)을 변경 가능

3. 사이트(요양원/경로당) 관리
   - 사이트 단위 정보(인원, 병상수, 구역수 등)
   - 사이트별 제품 할당(예: 닥터티슈 100개, 바디워시 100개 등)

4. 권한·메뉴 관리
   - 역할별 메뉴 표시/비표시
   - 세부 권한(읽기/쓰기/삭제/수정) 설정

5. 보고서 및 정산
   - 제품별/사이트별 월간 매출·수익 리포트
   - 배분 계산서(본사/지사/지점/협력사별)
   - CSV/Excel로 내보내기

6. 데이터 임포트/익스포트
   - Excel/CSV로 대량 제품 업로드(컬럼 매핑 UI 제공)
   - 템플릿 제공

7. 감사 로그 & 변경 이력
   - 제품 변경, 가격 변경, 사용자 액션 로깅

8. 알림 & 통지
   - 재고 부족/최소구매 미달 알림, 결제 지연 등

9. 배포/운영
   - 도커 기반 컨테이너화, SSL 적용, 백업 스케줄

---

## 4. 상세 기능 명세

### 4.1 제품 관리 (Product)
- 필드(권장)
  - id (PK)
  - sku (string, unique)
  - name (string)
  - description (text)
  - capacity (string, ex: 500ml)
  - unit (string, ex: 개, 박스)
  - cost_qty (decimal) - 원가 수량
  - cost_unit_price (decimal) - 원가 단가
  - cost_total (decimal) - 계산: cost_qty * cost_unit_price
  - supply_price (decimal) - 공급가(회사 → 협력사/지점)
  - sale_price (decimal) - 소비자 판매가
  - deposit (decimal) - 보증금(있다면)
  - one_time_fee (boolean) - 1회성 여부
  - profit_calc_rule_id (FK) - 수익 계산 규칙
  - images (첨부파일 참조)
  - is_active (boolean)
  - created_by, created_at, updated_by, updated_at

- 동작
  - 생성 시 유효성: cost_unit_price ≥ 0, supply_price ≥ 0, sale_price ≥ supply_price 권장(정책에 따라)
  - 수정 시 이전 값은 price_history로 남김
  - 삭제: 소프트 삭제(is_active=false) + audit log

- UI
  - 제품 목록: 필터(품명/용량/활성 여부), 정렬(매출, 이익률)
  - 제품 추가 모달/페이지: 입력폼 + 계산 미리보기(수익/배분)
  - 빠른 편집(inline) 및 상세 보기

### 4.2 수익·배분 계산 엔진
- 기본 변수
  - quantity (수량)
  - sale_price
  - supply_price
  - deposit
  - cost_total
  - distribution_percentages: {factory, hq, regional, branch, partner, hospital, 기타}

- 예시 계산식(구성 요소는 설정으로 변경 가능)
  - revenue = sale_price * quantity
  - direct_cost = cost_total * (quantity / cost_qty)  // 수량에 따른 원가 환산
  - gross_profit = revenue - direct_cost - (deposit * deposit_applicability)
  - distribution_amount(role) = gross_profit * distribution_percentages[role]

- 유의사항
  - 보증금(deposit)은 1회성 또는 반복적(예: 매 배송)인지 플래그로 저장
  - VAT/세금은 별도 항목으로 계산하여 최종 정산에 반영
  - 배분 비율은 본사에서 전역/지역/지구/지점 단위로 커스터마이즈 가능

### 4.3 사이트(거래처) 관리
- 필드(권장)
  - id, name, type(요양원/경로당/병원/기타), address, contact, population(인원), rooms, beds
  - assigned_products: JSON 또는 별도 테이블(site_products)

- 동작
  - 사이트별 제품 배정(표준 템플릿 저장 가능)
  - 정기 납품 스케줄 설정

### 4.4 사용자/권한 관리
- RBAC 모델 채택
  - Roles: superadmin, hq_admin, regional_admin, branch_admin, partner, hospital_user, data_entry, auditor
  - Permissions: 제품관리_C_R_U_D, 가격설정, 정산수정, 리포트_보기, 사용자관리, 설정_변경 등
- 권한에 따른 메뉴/필드 노출 제어
  - 예: 지점관리자는 가격설정 메뉴에 접근 불가하지만 재고/발주 메뉴는 접근 가능

### 4.5 보고서 & 정산
- 리포트 종류
  - 제품별 매출/수익(기간 선택)
  - 사이트별 P&L
  - 배분 리포트(본사/지사/지점/협력사 별 금액)
  - 보증금 수입 및 환급 현황
  - 월별/분기별 정산 내역 및 세금 계산서 발행 상태
- 내보내기: CSV/Excel/PDF

### 4.6 임포트/익스포트
- 제품 업로드 템플릿 제공(CSV)
- 컬럼 매핑 UI: 사용자가 업로드 시 컬럼을 시스템 필드에 맵핑 가능
- 업로드 검증: 중복 SKU 체크, 수치 범위 유효성 검사, 오류 레포트 제공

### 4.7 감사 로그 / 변경 이력
- 이벤트: 제품 생성/수정/삭제, 가격 변경, 권한 변경, 수동 정산
- 저장 내용: actor_user_id, action_type, before_data(JSON), after_data(JSON), timestamp, ip

### 4.8 알림 / 자동화
- 트리거 예시
  - 재고 < 임계값 → 알림(지점 관리자/본사)
  - 최소구매 미달 → 알림(본사)
  - 정산 마감 임박 → 알림(회계 담당)
- 전송수단: 이메일, 시스템 푸시, SMS(연동)

---

## 5. 데이터 모델(ERD 요약)

### 주요 테이블
- products
- product_price_history
- sites
- site_products (site_id, product_id, qty, sale_price_override, active)
- users
- roles
- permissions
- role_permission_map
- product_distribution_rules (region_id?, product_id?, distribution_json)
- transactions / invoices
- audit_logs

(세부 스키마는 아래 샘플 컬럼 참조)

### products (샘플 컬럼)
```
id PK
sku VARCHAR
name VARCHAR
capacity VARCHAR
unit VARCHAR
cost_qty DECIMAL
cost_unit_price DECIMAL
cost_total DECIMAL
supply_price DECIMAL
sale_price DECIMAL
deposit DECIMAL
one_time_fee BOOLEAN
profit_rule_id INT
images JSON
is_active BOOLEAN
created_at, updated_at
```

### site_products
```
id
site_id
product_id
quantity_default
sale_price_override
supply_price_override
is_active
```

### product_distribution_rules
```
id
product_id (nullable)  // null이면 전사 공통 룰
region_type (enum: nationwide/region/district/branch)
distribution_json (예: {factory:0.32, hq:0.03, regional:0.25, branch:0.02, nationwide:0.02, local:0.03, area:0.05, hospital:0.30})
applies_from, applies_to
```

---

## 6. API 설계(예시)

- 인증
  - POST /api/auth/login
  - POST /api/auth/refresh

- 제품
  - GET /api/products
  - GET /api/products/:id
  - POST /api/products
  - PUT /api/products/:id
  - DELETE /api/products/:id (soft delete)
  - POST /api/products/import (CSV)
  - GET /api/products/:id/price-history

- 사이트
  - GET /api/sites
  - POST /api/sites
  - PUT /api/sites/:id

- 배분 규칙
  - GET /api/distribution-rules
  - POST /api/distribution-rules

- 리포트
  - GET /api/reports/sales?from=&to=&site=&product=
  - GET /api/reports/distribution?period=

- 사용자/권한
  - GET /api/users
  - POST /api/users
  - POST /api/roles

- 알림
  - GET /api/notifications

---

## 7. 프론트엔드 화면 구조 & 메뉴(역할별 노출 포함)

### 전역 메뉴 (기본)
- 대시보드 (모든 역할, 단, 내용은 역할별로 다름)
- 제품 관리 (본사/관리자/데이터엔트리)
- 사이트 관리 (본사/지사/지점)
- 발주/재고 (지점/지사/본사)
- 정산/리포트 (본사/회계/감사)
- 사용자/권한 (본사, 시스템관리자)
- 설정(배분규칙, 가격정책) (본사)
- 임포트/익스포트 (본사/데이터엔트리)
- 감사로그 (감사/본사)

### 본사 관리자(HQ)
- 전체 대시보드
- 제품 관리(Full)
- 배분 규칙 설정
- 사이트 템플릿 관리
- 정산/배분 리포트
- 사용자/권한 관리

### 지사 관리자
- 지사 대시보드
- 지사 소속 지점 목록
- 지점별 리포트
- 발주관리

### 지점 관리자
- 지점 대시보드
- 제품 목록(지점 할당 제품)
- 발주/재고 입력
- 간단 리포트(일/월 매출)

### 협력사 / 병원 유저
- 납품 내역 조회
- 소비자 가격/매출(읽기전용)
- 계약/청구서 보기

---

## 8. UI 컴포넌트 상세(제품관리 중심)

1. 제품 리스트 테이블
   - 컬럼: SKU, 품명, 용량, 원가(단가/총계), 공급가, 판매가, 보증금, 이익률, 상태, 액션(편집/삭제)
   - 기능: 페이징, 검색, 필터(활성/비활성), 엑셀 내보내기

2. 제품 추가/수정 모달
   - 필드 + 계산 미리보기(즉시 반영)
   - 저장 시 price_history 자동 추가

3. 대량 업로드 화면
   - CSV 업로드, 필드 매핑, 시뮬레이션(오류 레포트)

4. 가격 시뮬레이터
   - 제품 선택 → 수량 입력 → 수익/배분 미리보기
   - 배분 비율을 임시로 변경하여 시뮬레이션 가능

5. 리포트 & 차트
   - 기간별 매출/수익 차트
   - 배분 항목별 파이 차트

---

## 9. CSV 템플릿 예시

`products_template.csv`
```
sku,name,capacity,unit,cost_qty,cost_unit_price,supply_price,sale_price,deposit,one_time_fee
DR-TISSUE-001,닥터티슈,1/60,팩,100,1500,2800,5000,0,TRUE
BODYWASH-500,바디워시,500ml,개,100,8000,3167,19000,0,FALSE
```

---

## 10. 보안·백업·운영

- 인증: JWT + Refresh token
- 암호화: 민감정보(비밀번호 등) 해시 저장, 전송 TLS 필수
- 백업: DB 일일 증분 백업 및 주간 전체 백업, 백업 보관 정책(예: 90일)
- 감사: 모든 가격/정산 변경은 audit_log에 기록
- 접근 제어: IP 화이트리스트(관리자 페이지), 2단계 인증 옵션

---

## 11. 배포 및 권장 기술 스택

- 프론트엔드: React + TypeScript (Vite 또는 Next.js)
- UI 라이브러리: TailwindCSS + shadcn/ui 또는 MUI
- 백엔드: Node.js (Express) + Socket.io(실시간 알림)
- DB: MySQL / MariaDB
- 캐시: Redis(세션/실시간 알림/큐)
- 인증: JWT
- 컨테이너: Docker + Docker Compose
- 리버스 프록시: Nginx
- CI/CD: GitHub Actions
- 호스팅: GCP / AWS / Vercel(프론트)

---

## 12. 테스트 및 수용기준

- 제품 CRUD: 제품 생성 후 목록 반영, price_history 생성 확인
- 배분 계산: 테스트 케이스(여러 배분 비율, 보증금 1회성/반복 적용) 통과
- 권한 검증: 역할별 페이지/API 접근 차단 확인
- 데이터 임포트: 템플릿 업로드 오류 없음, 오류 리포트 정확
- 감사 로그: 모든 쓰기 작업에 대해 로그가 남음

---

## 13. 우선순위(권장 개발 순서)

1. 인증/사용자/권한 시스템
2. 제품 CRUD + price history
3. 수익·배분 계산 엔진
4. 사이트(거래처) 관리 + site_products
5. 리포트(제품/사이트 기준) + CSV 내보내기
6. 임포트(대량 업로드) 기능
7. 알림/실시간(옵션)
8. 감사 로그, 백업 자동화

---

## 14. 개발자에게 전달할 간단 코멘트(요약)

- 제품 데이터 모델과 배분 규칙은 반드시 DB 테이블로 정규화. 비즈니스 규칙(보증금 1회/반복, 배분 비율)은 설정으로 만들 것.
- 권한은 RBAC로 구현하고, 메뉴/필드 노출은 권한 매핑으로 제어.
- 가격 계산 로직은 단위 테스트로 커버(여러 경우의 수: tax, deposit, override price 등).
- 대량 업로드는 사용자 친화적 오류 리포트가 핵심.

---

## 15. 다음 단계(제가 도와드릴 수 있는 작업)

- 이 요구사항을 기반으로 **OpenAPI(또는 Swagger) 스펙 생성**.
- **프론트엔드 화면(React + TypeScript) 컴포넌트 템플릿** 생성.
- **Express + MySQL 백엔드 스캐폴딩(엔티티/마이그레이션 포함)** 생성.
- 제공하신 엑셀 파일을 기반으로 **초기 제품 데이터 CSV** 변환.

원하시면 바로 하나 선택해서 시작할게요, 주인님.

---

*끝.*

